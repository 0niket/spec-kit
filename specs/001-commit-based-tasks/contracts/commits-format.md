# Contract: commits.md File Format

**Version**: 1.0.0
**Date**: 2025-12-11

## Overview

The `commits.md` file defines how tasks from `tasks.md` are grouped into logical git commits. It is generated by the `/speckit.commits` command and consumed by `/speckit.implement`.

## File Structure

```markdown
# Commits: [Feature Name]

**Generated**: [ISO 8601 timestamp]
**Source**: [path to tasks.md]
**Constitution**: [path to constitution.md]

## Summary

- Total Commits: [N]
- Total Tasks: [N] (non-repetitive) + [N] (repetitive)
- Stories Covered: [list]

---

## Commit 1: [type(scope): description]

**ID**: C001
**Status**: pending | in_progress | completed | failed
**Story**: [Story reference, e.g., US1]
**Git SHA**: <!-- populated by /speckit.implement after commit creation -->

### Non-Repetitive Tasks

- [ ] [T001] [P1] Task description `file/path.ext`
- [ ] [T002] [P1] Task description `file/path.ext`

### Repetitive Tasks

- [ ] [TDD-RED] Write failing test for [component]
- [ ] [TDD-GREEN] Implement [component] to pass test
- [ ] [TDD-REFACTOR] Refactor [component] if needed
- [ ] [VERIFY] Run make check

---

## Commit 2: [type(scope): description]
...
```

## Field Specifications

### Header Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Feature Name | Yes | string | Name from spec.md |
| Generated | Yes | ISO 8601 | Generation timestamp |
| Source | Yes | path | Relative path to tasks.md |
| Constitution | Yes | path | Relative path to constitution.md |

### Summary Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Total Commits | Yes | integer | Number of commits defined |
| Total Tasks | Yes | "N + M" | Non-repetitive + repetitive counts |
| Stories Covered | Yes | list | User story references |

### Commit Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Heading | Yes | `## Commit N: message` | Conventional commit message |
| ID | Yes | `C###` | Unique identifier |
| Status | Yes | enum | See status values below |
| Story | Yes | string | Primary user story reference |
| Git SHA | No | hex string | **Runtime only** - populated by `/speckit.implement` after git commit is created. Empty during planning. |

### Status Values

- `pending`: Not yet started
- `in_progress`: Currently executing tasks
- `completed`: All tasks done, git commit created
- `failed`: Task or verification failed

### Task Format

Non-repetitive tasks:

```text
- [ ] [T###] [P#] Description `optional/file/path.ext`
```

Repetitive tasks:

```text
- [ ] [TEMPLATE-ID] Description for [component]
```

## Parsing Rules

### For Bash Scripts

```bash
# Extract commit count
grep -c "^## Commit" commits.md

# Extract commit messages
grep "^## Commit" commits.md | sed 's/## Commit [0-9]*: //'

# Extract tasks for a commit (between two ## headers)
sed -n '/^## Commit 1:/,/^## Commit 2:/p' commits.md | grep "^\- \["

# Check if commit completed
grep -A 3 "^## Commit 1:" commits.md | grep "Status.*completed"
```

### For Claude Code

The slash command should:

1. Read entire file as Markdown
2. Parse `## Commit N:` sections as commit boundaries
3. Extract task checkboxes from each section
4. Update status and checkbox states during execution

## Validation Rules

1. **Task Coverage**: Every task ID in `tasks.md` must appear in exactly one commit
2. **Commit Ordering**: Commits must be ordered by dependency (earlier commits have no dependencies on later ones)
3. **Story Consistency**: All tasks in a commit should reference the same or related stories
4. **Conventional Format**: Commit messages must follow `type(scope): description` format

## Example

```markdown
# Commits: Diverge-Converge Workflow

**Generated**: 2025-12-11T10:30:00Z
**Source**: ./tasks.md
**Constitution**: ../../.specify/memory/constitution.md

## Summary

- Total Commits: 3
- Total Tasks: 8 (non-repetitive) + 12 (repetitive)
- Stories Covered: US1, US2

---

## Commit 1: feat(commits): add speckit.commits slash command

**ID**: C001
**Status**: pending
**Story**: US1
**Git SHA**: <!-- runtime -->

### Non-Repetitive Tasks

- [ ] [T001] [P1] Create speckit.commits.md command file `.claude/commands/speckit.commits.md`
- [ ] [T002] [P1] Implement task grouping logic in command

### Repetitive Tasks

- [ ] [TDD-RED] Write failing test for commits command
- [ ] [TDD-GREEN] Implement commits command to pass test
- [ ] [TDD-REFACTOR] Refactor commits command if needed
- [ ] [VERIFY] Run make check

---

## Commit 2: feat(commits): add constitution parsing

**ID**: C002
**Status**: pending
**Story**: US2
**Git SHA**: <!-- runtime -->

### Non-Repetitive Tasks

- [ ] [T003] [P1] Create parse-constitution.sh script `.specify/scripts/bash/parse-constitution.sh`
- [ ] [T004] [P1] Extract TDD requirements from constitution
- [ ] [T005] [P1] Extract linting requirements from constitution

### Repetitive Tasks

- [ ] [TDD-RED] Write failing test for constitution parser
- [ ] [TDD-GREEN] Implement parser to pass test
- [ ] [TDD-REFACTOR] Refactor parser if needed
- [ ] [LINT-BASH] Run shellcheck on new script
- [ ] [VERIFY] Run make check
```

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-11 | Initial specification |
