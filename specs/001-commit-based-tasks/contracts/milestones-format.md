# Contract: milestones.md File Format

**Version**: 1.0.0
**Date**: 2025-12-11

## Overview

The `milestones.md` file defines verification checkpoints by grouping commits into milestones. It is generated by the `/speckit.milestones` command and consumed by `/speckit.implement` to pause for manual verification.

## File Structure

```markdown
# Milestones: [Feature Name]

**Generated**: [ISO 8601 timestamp]
**Source**: [path to commits.md]
**Spec**: [path to spec.md]

## Summary

- Total Milestones: [N]
- Total Commits: [N]
- Verification Points: [N]

---

## Milestone 1: [User Story Title]

**ID**: M001
**Status**: pending | verification_required | verified | rejected
**Story**: [Story reference, e.g., US1]
**Priority**: P1 | P2 | P3
**Verified At**:
**Verified By**:

### Commits Included

1. [C001] feat(scope): commit message
2. [C002] test(scope): commit message

### Verification Criteria

> Derived from acceptance scenarios in spec.md

- [ ] [V001] Given [precondition], When [action], Then [result]
- [ ] [V002] Given [precondition], When [action], Then [result]
- [ ] [V003] Given [precondition], When [action], Then [result]

### Manual Verification Notes

[Space for reviewer to add comments during verification]

---

## Milestone 2: [User Story Title]
...
```

## Field Specifications

### Header Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Feature Name | Yes | string | Name from spec.md |
| Generated | Yes | ISO 8601 | Generation timestamp |
| Source | Yes | path | Relative path to commits.md |
| Spec | Yes | path | Relative path to spec.md |

### Summary Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Total Milestones | Yes | integer | Number of milestones |
| Total Commits | Yes | integer | Sum of commits across milestones |
| Verification Points | Yes | integer | Total verification criteria |

### Milestone Fields

| Field | Required | Format | Description |
|-------|----------|--------|-------------|
| Heading | Yes | `## Milestone N: title` | User story title |
| ID | Yes | `M###` | Unique identifier |
| Status | Yes | enum | See status values below |
| Story | Yes | string | User story reference |
| Priority | Yes | enum | P1, P2, P3 |
| Verified At | No | ISO 8601 | Verification timestamp |
| Verified By | No | string | Reviewer identifier |

### Status Values

- `pending`: Commits not yet completed
- `verification_required`: All commits done, awaiting review
- `verified`: Manual verification passed
- `rejected`: Verification failed, needs fixes

### Verification Criterion Format

```text
- [ ] [V###] Given [precondition], When [action], Then [result]
```

Or for non-scenario criteria:

```text
- [ ] [V###] [Description of what to verify]
```

## Parsing Rules

### For Bash Scripts

```bash
# Extract milestone count
grep -c "^## Milestone" milestones.md

# Extract milestone titles
grep "^## Milestone" milestones.md | sed 's/## Milestone [0-9]*: //'

# Check milestone status
grep -A 5 "^## Milestone 1:" milestones.md | grep "Status"

# Extract verification criteria for a milestone
sed -n '/^## Milestone 1:/,/^## Milestone 2:/p' milestones.md | grep "^\- \[.\] \[V"

# Count pending verifications
grep -c "\- \[ \] \[V" milestones.md
```

### For Claude Code

The slash command should:

1. Read entire file as Markdown
2. Parse `## Milestone N:` sections as milestone boundaries
3. Track status transitions
4. Pause execution when status becomes `verification_required`
5. Wait for user to update status to `verified` or `rejected`

## Verification Flow

```text
1. /speckit.implement executes commits
2. When all commits in milestone complete:
   - Status changes to 'verification_required'
   - Implementation PAUSES
   - User is prompted to verify

3. User verifies:
   - Checks each criterion
   - Marks [X] for passed, [ ] for failed
   - Adds notes if needed

4. User decision:
   - If all pass → Status = 'verified', continue to next milestone
   - If any fail → Status = 'rejected', implementation can rollback
```

## Validation Rules

1. **Commit Coverage**: Every commit ID in `commits.md` must appear in exactly one milestone
2. **Milestone Ordering**: Milestones must be ordered by priority (P1 first) then dependency
3. **Story Mapping**: Each milestone must reference a user story from spec
4. **Criteria Source**: Verification criteria must trace to acceptance scenarios in spec

## Example

```markdown
# Milestones: Diverge-Converge Workflow

**Generated**: 2025-12-11T11:00:00Z
**Source**: ./commits.md
**Spec**: ./spec.md

## Summary

- Total Milestones: 3
- Total Commits: 8
- Verification Points: 12

---

## Milestone 1: Group Tasks into Commits

**ID**: M001
**Status**: pending
**Story**: US1
**Priority**: P1
**Verified At**:
**Verified By**:

### Commits Included

1. [C001] feat(commits): add speckit.commits slash command
2. [C002] feat(commits): add task grouping algorithm
3. [C003] test(commits): add integration tests

### Verification Criteria

> From US1 Acceptance Scenarios

- [ ] [V001] Given a completed tasks.md, When I run /speckit.commits, Then commits.md contains commits with grouped tasks
- [ ] [V002] Given tasks that logically belong together, When commits are generated, Then they are grouped into a single commit
- [ ] [V003] Given a generated commits list, When I review it, Then each commit has a conventional commit message
- [ ] [V004] Given independent tasks, When commits are generated, Then they are in separate commits

### Manual Verification Notes

---

## Milestone 2: Add Repetitive Tasks from Constitution

**ID**: M002
**Status**: pending
**Story**: US2
**Priority**: P1
**Verified At**:
**Verified By**:

### Commits Included

1. [C004] feat(constitution): add constitution parser script
2. [C005] feat(commits): integrate repetitive task injection

### Verification Criteria

> From US2 Acceptance Scenarios

- [ ] [V005] Given a constitution requiring TDD, When commits are generated, Then each includes RED-GREEN-REFACTOR tasks
- [ ] [V006] Given a constitution requiring linting, When commits are generated, Then each includes "run linter" task
- [ ] [V007] Given documentation requirements, When commit changes public interfaces, Then documentation task included
- [ ] [V008] Given Playwright requirements, When commit involves UI, Then Playwright test tasks included

### Manual Verification Notes

---

## Milestone 3: Define Milestones for Verification

**ID**: M003
**Status**: pending
**Story**: US3
**Priority**: P2
**Verified At**:
**Verified By**:

### Commits Included

1. [C006] feat(milestones): add speckit.milestones slash command
2. [C007] feat(milestones): add verification criteria extraction
3. [C008] docs: update README with new commands

### Verification Criteria

> From US3 Acceptance Scenarios

- [ ] [V009] Given completed commits.md, When I run /speckit.milestones, Then milestones.md groups commits into milestones
- [ ] [V010] Given a milestone definition, When I review it, Then it includes specific verification criteria
- [ ] [V011] Given milestone reached, When AI reaches it, Then it pauses for verification
- [ ] [V012] Given multiple user stories, When milestones generated, Then each story maps to at least one milestone

### Manual Verification Notes
```

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-12-11 | Initial specification |
