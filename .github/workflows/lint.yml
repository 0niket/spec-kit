name: Lint
permissions:
  contents: read

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  markdownlint:
    name: Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'

  python-lint:
    name: Python (ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check src/

      - name: Run ruff format check
        run: ruff format --check src/

  shellcheck:
    name: Shell (shellcheck)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run shellcheck on scripts/bash
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts/bash'
          severity: warning

      - name: Run shellcheck on .github/workflows/scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './.github/workflows/scripts'
          severity: warning
          ignore_paths: '*.ps1'

  powershell-lint:
    name: PowerShell (PSScriptAnalyzer)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer on scripts/powershell
        shell: pwsh
        run: |
          # Exclude rules that are acceptable for CLI scripts:
          # - PSAvoidUsingWriteHost: Write-Host is appropriate for CLI feedback
          # - PSUseShouldProcessForStateChangingFunctions: Not needed for simple CLI tools
          # - PSUseApprovedVerbs: Custom verbs like Validate-, Parse-, Extract-, Print- are readable
          # - PSUseSingularNouns: Function names like Get-LanguageConventions are acceptable
          # - PSUseDeclaredVarsMoreThanAssignments: Some variables may be set but used conditionally
          # - PSReviewUnusedParameter: Script-level params are used but analyzer doesn't detect it
          $excludeRules = @(
            'PSAvoidUsingWriteHost',
            'PSUseShouldProcessForStateChangingFunctions',
            'PSUseApprovedVerbs',
            'PSUseSingularNouns',
            'PSUseDeclaredVarsMoreThanAssignments',
            'PSReviewUnusedParameter'
          )
          $results = Invoke-ScriptAnalyzer -Path ./scripts/powershell -Recurse -Severity Warning,Error -ExcludeRule $excludeRules
          if ($results) {
            $results | Format-Table -AutoSize
            exit 1
          }
          Write-Host "No issues found in scripts/powershell"

      - name: Run PSScriptAnalyzer on .github/workflows/scripts
        shell: pwsh
        run: |
          $ps1Files = Get-ChildItem -Path ./.github/workflows/scripts -Filter *.ps1 -ErrorAction SilentlyContinue
          if ($ps1Files) {
            $excludeRules = @(
              'PSAvoidUsingWriteHost',
              'PSUseShouldProcessForStateChangingFunctions',
              'PSUseApprovedVerbs',
              'PSUseSingularNouns',
              'PSUseDeclaredVarsMoreThanAssignments',
              'PSReviewUnusedParameter'
            )
            $results = $ps1Files | ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning,Error -ExcludeRule $excludeRules }
            if ($results) {
              $results | Format-Table -AutoSize
              exit 1
            }
          }
          Write-Host "No issues found in .github/workflows/scripts"
